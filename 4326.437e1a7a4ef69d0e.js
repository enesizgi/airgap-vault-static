"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4326],{42723:(C,M,o)=>{o.d(M,{K:()=>T});var u=o(20976),A=o(12714),v=o(84653),g=o(3323),m=o(34388),s=o(9527),b=o(51628),W=o(9288);let T=(()=>{class p{}return p.\u0275fac=function(I){return new(I||p)},p.\u0275mod=W.oAB({type:p}),p.\u0275inj=W.cJS({imports:[[g.Pc,b.D,A.ez,v.u5,m.aw,s.N,u.aD]]}),p})()},34326:(C,M,o)=>{o.r(M),o.d(M,{MigrationPageModule:()=>ke});var u=o(20976),A=o(12714),v=o(84653),g=o(3323),m=o(32256),s=o(25535),b=o(34388),W=o(42723),T=o(23345),p=o(65949),L=o(4402),I=o(41530),D=o(55956);const r="Migration",y=(0,s.PH)(`[${r}] View Will Enter`),P=(0,s.PH)(`[${r}] View Left`),h=(0,s.PH)(`[${r}] Navigation Data Loading`),S=(0,s.PH)(`[${r}] Navigation Data Loaded`,(0,s.Ky)()),E=(0,s.PH)(`[${r}] Invalid Navigation Data`),R=(0,s.PH)(`[${r}] Migration Started`),$=(0,s.PH)(`[${r}] Finished`),G=(0,s.PH)(`[${r}] Paranoia Accepted`),Z=(0,s.PH)(`[${r}] Paranoia Rejected`),j=(0,s.PH)(`[${r}] BIP-39 Passphrase Provided`,(0,s.Ky)()),z=(0,s.PH)(`[${r}] BIP-39 Passphrase rejected`),V=(0,s.PH)(`[${r}] Alert Dismissed`,(0,s.Ky)()),X=(0,s.PH)(`[${r}] Next Secret`,(0,s.Ky)()),q=(0,s.PH)(`[${r}] Secret Skipped`,(0,s.Ky)()),ee=(0,s.PH)(`[${r}] All Secrets Handled`),te=(0,s.PH)(`[${r}] Next Wallet`,(0,s.Ky)()),oe=(0,s.PH)(`[${r}] Wallet Skipped`,(0,s.Ky)()),ne=(0,s.PH)(`[${r}] All Wallets Handled`),ie=(0,s.PH)(`[${r}] Paranoia Detected`,(0,s.Ky)()),ae=(0,s.PH)(`[${r}] Invalid BIP-39 Passphrase`,(0,s.Ky)()),w=(0,s.PH)(`[${r}] Unknown Error`,(0,s.Ky)());var U=o(2853);function le(t,a){return t.publicKey===a.currentlyHandled?"migrating":a.alreadyHandled.has(t.publicKey)?(0,U.l)(t)?"migrated":"skipped":"waiting"}function ce(t,a,n){const i={waiting:0,migrating:0,migrated:0,skipped:0};return a.forEach(c=>{i[c.status]++}),t.id===n.currentlyHandled?"migrating":i.migrated===a.length?"migrated":i.skipped===a.length?"skipped":i.waiting===a.length?"waiting":i.migrating>0?"migrating":i.migrated+i.skipped===a.length?"partiallyMigrated":"waiting"}function de(t){return t.length>12?`${t.slice(0,5)}...${t.slice(-5)}`:t}const pe=(0,s.Lq)({targetSecrets:{status:u.Tq.IDLE,value:[]},targetWalletKeys:[],identifierToNameMap:{},handledSecretIds:[],handledWalletKeys:[],currentlyHandledSecretId:void 0,currentlyHandledWalletKey:void 0,alert:void 0},(0,s.on)(h,t=>Object.assign(Object.assign({},t),{targetSecrets:{status:u.Tq.LOADING,value:t.targetSecrets.value}})),(0,s.on)(S,(t,{secrets:a,targetWalletKeys:n,identifierToNameMap:i})=>Object.assign(Object.assign({},t),{targetSecrets:{status:u.Tq.SUCCESS,value:a},targetWalletKeys:n,identifierToNameMap:i,handledSecretIds:[],handledWalletKeys:[],currentlyHandledSecretId:void 0,currentlyHandledWalletKey:void 0,alert:void 0})),(0,s.on)(E,t=>Object.assign(Object.assign({},t),{targetSecrets:{status:u.Tq.ERROR,value:t.targetSecrets.value}})),(0,s.on)(X,(t,{id:a})=>Object.assign(Object.assign({},t),{handledSecretIds:void 0!==t.currentlyHandledSecretId?[...t.handledSecretIds,t.currentlyHandledSecretId]:t.handledSecretIds,currentlyHandledSecretId:a})),(0,s.on)(q,(t,{id:a})=>{var n,i,c;const l=null===(i=null===(n=t.targetSecrets.value)||void 0===n?void 0:n.find(d=>d.wrapped.id===a))||void 0===i?void 0:i.wrapped;return Object.assign(Object.assign({},t),{handledWalletKeys:t.handledWalletKeys.concat(null!==(c=null==l?void 0:l.wallets.map(d=>d.publicKey))&&void 0!==c?c:[])})}),(0,s.on)(ee,t=>Object.assign(Object.assign({},t),{handledSecretIds:void 0!==t.currentlyHandledSecretId?[...t.handledSecretIds,t.currentlyHandledSecretId]:t.handledSecretIds,currentlyHandledSecretId:void 0})),(0,s.on)(te,(t,{publicKey:a})=>Object.assign(Object.assign({},t),{handledWalletKeys:void 0!==t.currentlyHandledWalletKey?[...t.handledWalletKeys,t.currentlyHandledWalletKey]:t.handledWalletKeys,currentlyHandledWalletKey:a})),(0,s.on)(ne,t=>Object.assign(Object.assign({},t),{handledWalletKeys:void 0!==t.currentlyHandledWalletKey?[...t.handledWalletKeys,t.currentlyHandledWalletKey]:t.handledWalletKeys,currentlyHandledWalletKey:void 0})),(0,s.on)(ie,(t,{secretId:a})=>{var n,i;const c=null===(i=null===(n=t.targetSecrets.value)||void 0===n?void 0:n.find(l=>l.wrapped.id===a))||void 0===i?void 0:i.wrapped;return Object.assign(Object.assign({},t),{alert:void 0!==c?{id:(0,u.qs)(),value:{type:"paranoiaInfo",label:c.label},status:u.vQ.PENDING}:t.alert})}),(0,s.on)(ae,(t,{protocolIdentifier:a,publicKey:n})=>{var i,c,l;let d;for(const f of null!==(i=t.targetSecrets.value)&&void 0!==i?i:[])if(d=(null!==(c=f.walletsGrouped[a])&&void 0!==c?c:{})[n],void 0!==d)break;return Object.assign(Object.assign({},t),{alert:void 0!==d?{id:(0,u.qs)(),value:{type:"bip39Passphrase",protocolName:null!==(l=t.identifierToNameMap[a])&&void 0!==l?l:a,address:d.receivingPublicAddress},status:u.vQ.PENDING}:t.alert})}),(0,s.on)(w,(t,{message:a})=>Object.assign(Object.assign({},t),{alert:{id:(0,u.qs)(),value:{type:"unknownError",message:(null==a?void 0:a.length)>0?a:void 0},status:u.vQ.PENDING}})),(0,s.on)(V,(t,{id:a})=>Object.assign(Object.assign({},t),{alert:void 0!==t.alert?{id:t.alert.id,value:t.alert.value,status:a===t.alert.id?u.vQ.HANDLED:t.alert.status}:void 0}))),x=(0,s.ZF)("migration"),B=(0,s.P1)(x,t=>{var a;return{status:t.targetSecrets.status,value:null===(a=t.targetSecrets.value)||void 0===a?void 0:a.map(n=>n.wrapped)}}),F=(0,s.P1)(x,t=>t.targetWalletKeys),fe=(0,s.P1)(x,t=>t.handledSecretIds),se=(0,s.P1)(x,t=>t.handledWalletKeys),Q=(0,s.P1)(x,t=>t.currentlyHandledSecretId),J=(0,s.P1)(x,t=>t.currentlyHandledWalletKey),me=(0,s.P1)(x,t=>t.alert),he=(0,s.P1)(B,F,se,Q,J,(t,a,n,i,c)=>{const l=[];if(void 0!==t.value&&t.value.length>0){const d=new Set(a),f=new Set(n);for(const _ of t.value){const N=_.wallets.filter(K=>d.has(K.publicKey)).map(K=>({status:le(K,{currentlyHandled:c,alreadyHandled:f}),data:K}));l.push({id:_.id,label:_.label,status:ce(_,N,{currentlyHandled:i}),wallets:N})}}return{status:t.status,value:l}}),ve=(0,s.P1)(Q,J,(t,a)=>void 0!==t||void 0!==a),_e=(0,s.P1)(B,F,fe,se,Q,J,(t,a,n,i,c,l)=>{var d,f;return n.length>=(null!==(f=null===(d=t.value)||void 0===d?void 0:d.length)&&void 0!==f?f:0)&&i.length>=a.length&&void 0===c&&void 0===l});var e=o(9288);function ye(t,a){1&t&&e._UZ(0,"ion-spinner",21)}function Pe(t,a){1&t&&e._UZ(0,"ion-icon",22)}function Se(t,a){1&t&&e._UZ(0,"ion-icon",23)}function Ae(t,a){1&t&&e._UZ(0,"ion-icon",24)}function Me(t,a){1&t&&e._UZ(0,"ion-icon",25)}function Ie(t,a){if(1&t&&(e.ynx(0),e.YNc(1,ye,1,0,"ion-spinner",16),e.YNc(2,Pe,1,0,"ion-icon",17),e.YNc(3,Se,1,0,"ion-icon",18),e.YNc(4,Ae,1,0,"ion-icon",19),e.YNc(5,Me,1,0,"ion-icon",20),e.BQk()),2&t){const n=e.oxw().$implicit;e.xp6(1),e.Q6J("ngIf","migrating"===n.status),e.xp6(1),e.Q6J("ngIf","migrated"===n.status),e.xp6(1),e.Q6J("ngIf","skipped"===n.status),e.xp6(1),e.Q6J("ngIf","partiallyMigrated"===n.status),e.xp6(1),e.Q6J("ngIf","waiting"===n.status)}}function Ee(t,a){1&t&&e._UZ(0,"ion-spinner",32)}function Oe(t,a){1&t&&e._UZ(0,"ion-icon",33)}function be(t,a){1&t&&e._UZ(0,"ion-icon",34)}function De(t,a){1&t&&e._UZ(0,"ion-icon",35)}function Ke(t,a){if(1&t&&(e.ynx(0),e.YNc(1,Ee,1,0,"ion-spinner",28),e.YNc(2,Oe,1,0,"ion-icon",29),e.YNc(3,be,1,0,"ion-icon",30),e.YNc(4,De,1,0,"ion-icon",31),e.BQk()),2&t){const n=e.oxw().$implicit;e.xp6(1),e.Q6J("ngIf","migrating"===n.status),e.xp6(1),e.Q6J("ngIf","migrated"===n.status),e.xp6(1),e.Q6J("ngIf","skipped"===n.status),e.xp6(1),e.Q6J("ngIf","waiting"===n.status)}}function xe(t,a){if(1&t&&(e.TgZ(0,"ion-item")(1,"span",26),e._UZ(2,"airgap-account-item",27),e.qZA(),e.YNc(3,Ke,5,4,"ng-container",15),e.ALo(4,"async"),e.ALo(5,"async"),e.qZA()),2&t){const n=a.$implicit,i=e.oxw(3);e.xp6(2),e.Q6J("wallet",n.data),e.xp6(1),e.Q6J("ngIf",e.lcZ(4,2,i.isRunning$)||e.lcZ(5,4,i.isDone$))}}function We(t,a){if(1&t&&(e.ynx(0),e.TgZ(1,"ion-item",13)(2,"ion-label",14),e._uU(3),e.qZA(),e.YNc(4,Ie,6,5,"ng-container",15),e.ALo(5,"async"),e.ALo(6,"async"),e.qZA(),e.TgZ(7,"ion-list",9),e.YNc(8,xe,6,6,"ion-item",12),e.qZA(),e.BQk()),2&t){const n=a.$implicit,i=e.oxw(2);e.xp6(3),e.Oqu(n.label),e.xp6(1),e.Q6J("ngIf",e.lcZ(5,3,i.isRunning$)||e.lcZ(6,5,i.isDone$)),e.xp6(4),e.Q6J("ngForOf",n.wallets)}}function Te(t,a){if(1&t&&(e.TgZ(0,"ion-list",9)(1,"ion-list-header",10),e._UZ(2,"ion-label",11),e.ALo(3,"translate"),e.qZA(),e.YNc(4,We,9,7,"ng-container",12),e.ALo(5,"async"),e.qZA()),2&t){const n=e.oxw();e.xp6(2),e.Q6J("innerHtml",e.lcZ(3,2,"migration.list.header"),e.oJD),e.xp6(2),e.Q6J("ngForOf",e.lcZ(5,4,n.walletGroups$).value)}}function $e(t,a){if(1&t){const n=e.EpF();e.TgZ(0,"ion-button",36),e.NdJ("click",function(){return e.CHM(n),e.oxw().run()}),e.ALo(1,"async"),e._uU(2),e.ALo(3,"translate"),e.qZA()}if(2&t){const n=e.oxw();e.Q6J("disabled",e.lcZ(1,2,n.isRunning$)),e.xp6(2),e.hij(" ",e.lcZ(3,4,"migration.button-run_label")," ")}}function He(t,a){if(1&t){const n=e.EpF();e.TgZ(0,"ion-button",37),e.NdJ("click",function(){return e.CHM(n),e.oxw().finish()}),e._uU(1),e.ALo(2,"translate"),e.qZA()}2&t&&(e.xp6(1),e.hij(" ",e.lcZ(2,1,"migration.button-done_label")," "))}const Ne=[{path:"",component:(()=>{class t{constructor(n,i,c){this.store=n,this.uiEventService=i,this.translateService=c,this.UIResourceStatus=u.Tq,this.ngDestroyed$=new L.xQ,this.walletGroups$=this.store.select(he),this.isRunning$=this.store.select(ve),this.isDone$=this.store.select(_e),this.alert$=this.store.select(me),this.alert$.pipe((0,I.R)(this.ngDestroyed$)).subscribe(this.showOrDismissAlert.bind(this))}ionViewWillEnter(){this.store.dispatch(y())}ionViewDidLeave(){this.store.dispatch(P())}ngOnDestroy(){this.ngDestroyed$.next(),this.ngDestroyed$.complete()}run(){this.store.dispatch(R())}finish(){this.store.dispatch($())}showOrDismissAlert(n){var i;return(0,p.mG)(this,void 0,void 0,function*(){if(null===(i=this.alertElement)||void 0===i||i.dismiss().catch((0,D.a1)(D.qj.IONIC_ALERT)),(null==n?void 0:n.status)===u.vQ.PENDING)return this.alertElement=yield this.uiEventService.getTranslatedAlert(this.getAlertData(n.value)),this.alertElement.present().catch((0,D.a1)(D.qj.IONIC_ALERT)),this.alertElement.onWillDismiss().then(()=>{this.store.dispatch(V({id:n.id}))}).catch((0,D.a1)(D.qj.IONIC_ALERT));this.alertElement=void 0})}getAlertData(n){switch(n.type){case"paranoiaInfo":return this.paranoiaInfoAlert(n.label);case"bip39Passphrase":return this.bip39PassphraseAlert(n.address,n.protocolName);case"unknownError":return this.unknownErrorAlert(n.message);default:return{}}}paranoiaInfoAlert(n){return{header:"migration.alert.paranoia-info.header",message:this.translateService.instant("migration.alert.paranoia-info.message",{label:n}),backdropDismiss:!1,buttons:[{text:"migration.alert.paranoia-info.button-skip_label",handler:()=>{this.store.dispatch(Z())}},{text:"migration.alert.paranoia-info.button-ok_label",handler:()=>{this.store.dispatch(G())}}]}}bip39PassphraseAlert(n,i){return{header:"migration.alert.bip39-passphrase.header",message:this.translateService.instant("migration.alert.bip39-passphrase.message",{address:de(n),protocol:i}),backdropDismiss:!1,inputs:[{name:"bip39Passphrase",type:"password",placeholder:"migration.alert.bip39-passphrase.input-placeholder_label"}],buttons:[{text:"migration.alert.bip39-passphrase.button-skip_label",handler:()=>{this.store.dispatch(z())}},{text:"migration.alert.bip39-passphrase.button-ok_label",handler:c=>{var l;const d=null!==(l=c.bip39Passphrase)&&void 0!==l?l:"";this.store.dispatch(j({passphrase:d}))}}]}}unknownErrorAlert(n){return{header:"migration.alert.unknown-error.header",message:null!=n?n:"migration.alert.unknown-error.message",backdropDismiss:!0,buttons:[{text:"migration.alert.unknown-error.button_label"}]}}}return t.\u0275fac=function(n){return new(n||t)(e.Y36(s.yh),e.Y36(u.Ax),e.Y36(b.sK))},t.\u0275cmp=e.Xpm({type:t,selectors:[["airgap-migration"]],decls:20,vars:19,consts:[[1,"ion-no-border"],["slot","start"],["defaultHref","/tabs/tab-secrets"],[1,"ion-padding"],[1,"ion-padding-bottom"],["lines","none",4,"ngIf"],["vertical","bottom","horizontal","end","slot","fixed"],["color","primary","shape","round",3,"disabled","click",4,"ngIf"],["color","primary","shape","round",3,"click",4,"ngIf"],["lines","none"],[1,"ion-no-padding"],["color","light",3,"innerHtml"],[4,"ngFor","ngForOf"],["detail","false",1,"ion-no-padding"],["color","light"],[4,"ngIf"],["name","lines","slot","end",4,"ngIf"],["name","checkmark-done-outline","slot","end",4,"ngIf"],["name","close-outline","slot","end",4,"ngIf"],["name","alert-outline","slot","end",4,"ngIf"],["name","time-outline","slot","end",4,"ngIf"],["name","lines","slot","end"],["name","checkmark-done-outline","slot","end"],["name","close-outline","slot","end"],["name","alert-outline","slot","end"],["name","time-outline","slot","end"],[1,"airgap-account-item-migration"],[3,"wallet"],["name","lines-small","slot","end",4,"ngIf"],["name","checkmark-outline","size","small","slot","end",4,"ngIf"],["name","close-outline","size","small","slot","end",4,"ngIf"],["name","time-outline","size","small","slot","end",4,"ngIf"],["name","lines-small","slot","end"],["name","checkmark-outline","size","small","slot","end"],["name","close-outline","size","small","slot","end"],["name","time-outline","size","small","slot","end"],["color","primary","shape","round",3,"disabled","click"],["color","primary","shape","round",3,"click"]],template:function(n,i){1&n&&(e.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),e._UZ(3,"ion-back-button",2),e.qZA(),e.TgZ(4,"ion-title"),e._uU(5),e.ALo(6,"translate"),e.qZA()()(),e.TgZ(7,"ion-content",3)(8,"h3",4),e._uU(9),e.ALo(10,"translate"),e.qZA(),e.YNc(11,Te,6,6,"ion-list",5),e.ALo(12,"async"),e.TgZ(13,"ion-fab",6),e.YNc(14,$e,4,6,"ion-button",7),e.ALo(15,"async"),e.ALo(16,"async"),e.YNc(17,He,3,3,"ion-button",8),e.ALo(18,"async"),e.ALo(19,"async"),e.qZA()()),2&n&&(e.xp6(5),e.Oqu(e.lcZ(6,5,"migration.title")),e.xp6(4),e.Oqu(e.lcZ(10,7,"migration.heading")),e.xp6(2),e.Q6J("ngIf",e.lcZ(12,9,i.walletGroups$).status===i.UIResourceStatus.SUCCESS),e.xp6(3),e.Q6J("ngIf",e.lcZ(15,11,i.walletGroups$).status===i.UIResourceStatus.SUCCESS&&!e.lcZ(16,13,i.isDone$)),e.xp6(3),e.Q6J("ngIf",e.lcZ(18,15,i.walletGroups$).status!==i.UIResourceStatus.IDLE&&e.lcZ(19,17,i.isDone$)))},directives:[g.Gu,g.sr,g.Sm,g.oU,g.cs,g.wd,g.W2,A.O5,g.q_,g.yh,g.Q$,A.sg,g.Ie,g.PQ,g.gu,u.vq,g.IJ,g.YG],pipes:[b.X$,A.Ov],styles:["ion-icon[_ngcontent-%COMP%]{color:#fff}ion-content[_ngcontent-%COMP%]{--padding-bottom: var(--ion-padding, 64px)}"]}),t})()}];let Le=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[T.Bz.forChild(Ne)],T.Bz]}),t})();var Ge=o(88061),Ce=o(47898),Re=o(30243),Ze=o(48060),je=o(67926),Ue=o(39722),Y=o(68019),re=o(24586),we=o(39141),H=o(29508),Be=o(13187),Fe=o(27204),Qe=o(56810);class k{constructor(a,n){this.walletsGrouped=a,this.wrapped=n}static fromMnemonicSecret(a){return(0,p.mG)(this,void 0,void 0,function*(){const n=yield function ue(t){return(0,p.mG)(this,void 0,void 0,function*(){return(yield Promise.all(t.map(n=>(0,p.mG)(this,void 0,void 0,function*(){return[yield n.protocol.getIdentifier(),[n.publicKey,n]]})))).reduce((n,i)=>Object.assign(n,{[i[0]]:{[i[1][0]]:i[1][1]}}),{})})}(a.wallets);return new k(n,a)})}}var O=(()=>{return(t=O||(O={})).PARANOIA_ACCEPTED="paranoiaAccepted",t.BIP39_PASSPHRASE="bip39Passphrase",O;var t})();let Ye=(()=>{class t{constructor(n,i,c,l,d){this.actions$=n,this.store=i,this.navigationService=c,this.secretsService=l,this.migrationService=d,this.exposedPromises=new u.Im,this.navigationData$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)(y),(0,Y.M)(this.secretsService.getSecretsObservable()),(0,re.w)(([f,_])=>(0,Re.z)((0,Ze.of)(h()),(0,je.D)(this.loadNavigationData(_)).pipe((0,we.P)()))))),this.migrationProgress$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)(R),(0,Y.M)(this.store.select(B)),(0,Y.M)(this.store.select(F)),(0,re.w)(([[f,_],N])=>{var K;return this.migrate(null!==(K=_.value)&&void 0!==K?K:[],N)}))),this.paranoiaAccepted$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)(G),(0,H.b)(()=>{this.exposedPromises.resolve(O.PARANOIA_ACCEPTED,!0)})),{dispatch:!1}),this.paranoiaRejected$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)(Z),(0,H.b)(()=>{this.exposedPromises.resolve(O.PARANOIA_ACCEPTED,!1)})),{dispatch:!1}),this.bip39Passphrase$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)(j),(0,H.b)(f=>{this.exposedPromises.resolve(O.BIP39_PASSPHRASE,f.passphrase)})),{dispatch:!1}),this.bip39PassphraseRejected$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)(z),(0,H.b)(()=>{this.exposedPromises.resolve(O.BIP39_PASSPHRASE,void 0)})),{dispatch:!1}),this.finished$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)($),(0,H.b)(()=>{this.finish()})),{dispatch:!1}),this.onLeft$=(0,m.GW)(()=>this.actions$.pipe((0,m.l4)(P),(0,H.b)(()=>{this.callCallbacks()})),{dispatch:!1})}loadNavigationData(n){return(0,p.mG)(this,void 0,void 0,function*(){const i=this.navigationService.getState();this.onSuccess=i.onSuccess,this.onError=i.onError;const[c,l]=this.getSecretsAndTargetWalletKeys(i,n),d=c?yield Promise.all(c.map(_=>k.fromMnemonicSecret(_))):void 0,f=void 0!==c?yield this.getIdentifierToNameMap(c):void 0;return void 0!==d&&void 0!==l&&void 0!==f?S({secrets:d,targetWalletKeys:l,identifierToNameMap:f}):E()})}getSecretsAndTargetWalletKeys(n,i){if(void 0!==n.secrets){const c=n.secrets.filter(d=>!(0,U.e)(d)),l=(0,u.$t)(c.map(d=>d.wallets.filter(f=>f.status===Ge.AirGapWalletStatus.ACTIVE&&!(0,U.l)(f)).map(f=>f.publicKey)));return[c,l]}if(void 0!==n.wallets){const l=n.wallets.filter(_=>!(0,U.l)(_)).map(_=>_.publicKey),d=new Set(l);return[i.filter(_=>_.wallets.some(N=>d.has(N.publicKey))),l]}return[void 0,void 0]}getIdentifierToNameMap(n){return(0,p.mG)(this,void 0,void 0,function*(){return(0,u.$t)(yield Promise.all(n.map(c=>Promise.all(c.wallets.map(l=>(0,p.mG)(this,void 0,void 0,function*(){return[yield l.protocol.getIdentifier(),yield l.protocol.getName()]})))))).reduce((c,l)=>Object.assign(c,{[l[0]]:l[1]}),{})})}migrate(n,i){return new Ue.y(c=>{new Promise(l=>(0,p.mG)(this,void 0,void 0,function*(){const d=new Set(i);for(const f of n)yield this.migrateSecret(c,f,d);c.next(ee()),l()})).catch(l=>{c.next(w({message:"string"==typeof l?l:l.message}))}).finally(()=>{c.complete()})})}migrateSecret(n,i,c){return(0,p.mG)(this,void 0,void 0,function*(){if(n.next(X({id:i.id})),i.isParanoia&&!(yield this.waitForParanoiaAccepted(n,i)))return void n.next(q({id:i.id}));const l=yield this.secretsService.retrieveEntropyForSecret(i),d=(0,Ce.entropyToMnemonic)(l);yield this.migrationService.migrateSecret(i,{mnemonic:d,persist:!1});for(const f of i.wallets.filter(_=>c.has(_.publicKey)))yield this.migrateWallet(n,f,d);n.next(ne()),yield this.secretsService.addOrUpdateSecret(i,{setActive:!1})})}waitForParanoiaAccepted(n,i){return(0,p.mG)(this,void 0,void 0,function*(){return n.next(ie({secretId:i.id})),this.exposedPromises.yield(O.PARANOIA_ACCEPTED)})}migrateWallet(n,i,c){return(0,p.mG)(this,void 0,void 0,function*(){n.next(te({publicKey:i.publicKey})),yield function Je(t){return(0,p.mG)(this,void 0,void 0,function*(){let a,n,i=t.initArgs;do{try{n="abort",a=yield t.action(i)}catch(c){const l=yield t.onFailure(c);n=l.type,i=l.nextArgs}}while("retry"===n);return a})}({initArgs:"",action:l=>this.migrationService.migrateWallet(i,{mnemonic:c,bip39Passphrase:l,persist:!1}),onFailure:l=>(0,p.mG)(this,void 0,void 0,function*(){if(this.isInvalidBip39PassphraseError(l)){const d=yield this.askForBip39Passphrase(n,i);return void 0===d?(n.next(oe({publicKey:i.publicKey})),{type:"abort"}):{type:"retry",nextArgs:d}}return n.next(w({message:"string"==typeof l?l:l.message})),{type:"abort"}})})})}askForBip39Passphrase(n,i){return(0,p.mG)(this,void 0,void 0,function*(){return n.next(ae({protocolIdentifier:yield i.protocol.getIdentifier(),publicKey:i.publicKey})),this.exposedPromises.yield(O.BIP39_PASSPHRASE)})}finish(){this.navigationService.back()}callCallbacks(){void 0!==this.onSuccess&&this.onSuccess()}isInvalidBip39PassphraseError(n){var i;return null===(i=n.message)||void 0===i?void 0:i.toLowerCase().startsWith("invalid bip-39 passphrase")}}return t.\u0275fac=function(n){return new(n||t)(e.LFG(m.eX),e.LFG(s.yh),e.LFG(Fe.f),e.LFG(Qe.R),e.LFG(Be.H))},t.\u0275prov=e.Yz7({token:t,factory:t.\u0275fac}),t})(),ke=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[A.ez,W.K,v.u5,g.Pc,b.aw,Le,s.Aw.forFeature("migration",pe),m.sQ.forFeature([Ye]),u.aD]]}),t})()},51628:(C,M,o)=>{o.d(M,{D:()=>A});var u=o(9288);let A=(()=>{class v{}return v.\u0275fac=function(m){return new(m||v)},v.\u0275mod=u.oAB({type:v}),v.\u0275inj=u.cJS({imports:[[]]}),v})()},13187:(C,M,o)=>{o.d(M,{H:()=>L});var u=o(65949),A=o(88061),v=o(90544),g=o(47898),m=o(52971),s=o(2853),b=o(55956),W=o(27204),T=o(56810),p=o(9288);let L=(()=>{class I{constructor(r,y){this.secretsService=r,this.navigationService=y}runSecretsMigration(r){return(0,u.mG)(this,void 0,void 0,function*(){return new Promise((y,P)=>{r.every(s.e)?y():this.navigateToMigrationPage({secrets:r}).then(y).catch(P)})})}runWalletsMigration(r){return(0,u.mG)(this,void 0,void 0,function*(){return new Promise((y,P)=>{r.every(s.l)?y():this.navigateToMigrationPage({wallets:r}).then(y).catch(P)})})}navigateToMigrationPage(r){return(0,u.mG)(this,void 0,void 0,function*(){return new Promise((y,P)=>{this.navigationService.routeWithState("/migration",Object.assign(Object.assign({},r),{onSuccess:y,onError:P})).catch(h=>{(0,b.a1)(b.qj.IONIC_NAVIGATION)(h),P(h)})})})}filterMigratedSecrets(r){return r.every(s.e)?[r,!0]:[r.filter(s.e),!1]}filterMigratedWallets(r){return r.every(s.l)?[r,!0]:[r.filter(s.l),!1]}deepFilterMigratedSecretsAndWallets(r){return(0,u.mG)(this,void 0,void 0,function*(){return r.every(s.e)?[r,!0]:[(yield Promise.all(r.map(P=>(0,u.mG)(this,void 0,void 0,function*(){if(!P.fingerprint)return;const[h]=this.filterMigratedWallets(P.wallets);if(0===h.length)return;const S=m.r.init(P);return S.wallets=h,S})))).filter(P=>void 0!==P),!1]})}migrateSecret(r,y={}){return(0,u.mG)(this,void 0,void 0,function*(){const h=Object.assign(Object.assign({},{persist:!1}),y);if(void 0===r.fingerprint){let S=h.mnemonic;if(void 0===S){const G=yield this.secretsService.retrieveEntropyForSecret(r);S=(0,g.entropyToMnemonic)(G)}const E=yield(0,g.mnemonicToSeed)(S),$=(0,v.fromSeed)(E).fingerprint.toString("hex");r.fingerprint=$}h.persist&&(yield this.secretsService.addOrUpdateSecret(r,{setActive:!1}))})}migrateWallet(r,y){return(0,u.mG)(this,void 0,void 0,function*(){const h=Object.assign(Object.assign({},{bip39Passphrase:"",persist:!1}),y);if(r.masterFingerprint&&!h.persist)return;let E,S=h.mnemonic;if((void 0===S||h.persist)&&(E=this.secretsService.findByPublicKey(r.publicKey)),void 0===S&&void 0!==E){const j=yield this.secretsService.retrieveEntropyForSecret(E);S=(0,g.entropyToMnemonic)(j)}else if(void 0===S)return;if((yield r.protocol.getPublicKeyFromMnemonic(S,r.derivationPath,h.bip39Passphrase))!==r.publicKey)throw new Error("Invalid BIP-39 Passphrase");const $=yield(0,g.mnemonicToSeed)(S,h.bip39Passphrase),Z=(0,v.fromSeed)($).fingerprint.toString("hex");r.masterFingerprint=Z,r.status=A.AirGapWalletStatus.ACTIVE,h.persist&&void 0!==E&&(yield this.migrateSecret(E,{mnemonic:h.mnemonic,persist:h.persist}))})}}return I.\u0275fac=function(r){return new(r||I)(p.LFG(T.R),p.LFG(W.f))},I.\u0275prov=p.Yz7({token:I,factory:I.\u0275fac,providedIn:"root"}),I})()},2853:(C,M,o)=>{function u(v){return v.fingerprint&&v.wallets.every(A)}function A(v){return!!v.masterFingerprint}o.d(M,{e:()=>u,l:()=>A})}}]);